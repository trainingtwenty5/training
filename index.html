<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Drzewko Umiejętności Breaking</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>

:root {
  --bg: white;
  --panel: #151936;
  --text: #000000;
  --accent: #ffffff;
  --accent-2: #6df0c2;
  --locked: #0215c0;
  --unlocked: rgb(0, 247, 255);
  --connector: rgb(0, 247, 255);
  --level1: #FFD700;  /* Żółty dla poziomu 1 */
  --level2: #4CAF50;  /* Zielony dla poziomu 2 */
  --level0: #4CAF50;  /* Czerwony dla zablokowanych (poziom 0) */

  

  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.2);
  --transition: all 0.3s ease;
}
/* Style dla branch-skill */
.branch-skill.level0 { background: var(--level0); }
.branch-skill.level1 { background: var(--level1); }
.branch-skill.level2 { background: var(--level2); }
.branch-skill.level3 { background: var(--level3); }

/* Style dla main-skill */
.main-skill.level0 { background: var(--level0); }
.main-skill.level1 { background: var(--level1); }
.main-skill.level2 { background: var(--level2); }
.main-skill.level3 { background: var(--level3); }
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Inter', 'SF Pro Text', Roboto, Arial, sans-serif;
  background: white;
  color: var(--text);
  overflow-x: hidden;
  padding: 20px;
  min-height: 100vh;
  line-height: 1.6;
  transform: scale(0.8);
  transform-origin: top center; /* zaczyna skalowanie od góry i środka ekranu */
}

.container { max-width: 1400px; margin: 0 auto; }

header { text-align: center; margin-bottom: 30px; padding: 20px; }

.branch-progress {
  text-align: center;
  margin-top: 10px;
  font-size: 0.8rem;
  color: rgb(255, 255, 255);/* --text = #000000 czyli czarny */
  background: rgb(0, 0, 0); /* lekko przezroczysty ciemny pasek */
  padding: 4px 8px;
  border-radius: var(--radius-md);
}

h1 {
  font-size: 2.5rem;
  margin-bottom: 10px;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  font-weight: 800;
}

.subtitle {
  color: #8a90b0;
  font-size: 1.1rem;
  max-width: 600px;
  margin: 0 auto;
}

/* Ekran logowania */
.auth-container {
  max-width: 400px;
  margin: 100px auto;
  padding: 30px;
  background: var(--panel);
  border-radius: var(--radius-xl);
  border: 1px solid rgba(255, 255, 255, 0.308);
  box-shadow: var(--shadow-lg);
  backdrop-filter: blur(10px);
}

.auth-container h2 { text-align: center; margin-bottom: 20px; font-weight: 700; }

.auth-input {
  width: 100%;
  padding: 12px 14px;
  margin-bottom: 15px;
  border-radius: var(--radius-lg);
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgb(255, 255, 255);
  color: var(--text);
  font-size: 1rem;
  transition: var(--transition);
}

.auth-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 2px rgb(255, 255, 255);
}

.auth-button {
  width: 100%;
  padding: 12px;
  border-radius: var(--radius-lg);
  border: none;
  background: linear-gradient(90deg, var(--accent), var(--accent-2));
  color: var(--bg);
  font-weight: 600;
  cursor: pointer;
  margin-bottom: 10px;
  transition: var(--transition);
}

.auth-button:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }

.auth-switch {
  text-align: center;
  color: #000000;
  margin-top: 20px;
  cursor: pointer;
  transition: var(--transition);
}

.auth-switch:hover { color: var(--accent); }

.error-message { color: #ff6b6b; text-align: center; margin: 10px 0; font-size: 14px; }

/* Panel użytkownika */
.user-panel {
  position: fixed;
  top: 20px;
  right: 20px;
  background: rgba(255, 255, 255, 0.301);
  padding: 15px;
  border-radius: var(--radius-lg);
  border: 1px solid rgb(0, 0, 0);
  z-index: 10;
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-width: 200px;
  backdrop-filter: blur(10px);
  box-shadow: var(--shadow-md);
}

.user-info { display: flex; align-items: center; gap: 10px; }

.user-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), var(--accent-2));
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  box-shadow: var(--shadow-sm);
}

.user-name { font-weight: 600; }

.progress-bar { height: 6px; background: var(--locked); border-radius: 3px; overflow: hidden; }

.progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); border-radius: 3px; transition: width 0.5s ease; }

.progress-text { font-size: 0.8rem; text-align: center; opacity: 0.8; z-index: 100;}

.logout-btn {
  padding: 8px;
  background: rgba(128, 17, 17, 0.322);
  color: rgb(0, 0, 0);
  border: none;
  border-radius: var(--radius-md);
  cursor: pointer;
  font-weight: 600;
  transition: var(--transition);
}

.logout-btn:hover { background: #000000ab;; transform: translateY(-1px); }

/* Przyciski zwijania/rozwijania gałęzi na telefonach */
.toggle-branch {
  position: absolute;
  top: 5px;
  right: 5px;
  font-size: 1.3rem;
  color: var(--text);
  cursor: pointer;
  z-index: 10;
}

.level { position: relative; }

/* Responsywność - ULEPSZONA */
@media (max-width: 1200px) {
  .branch-left { right: calc(50% + 80px); }
  .branch-right { left: calc(50% + 80px); }
  .branch::before { width: 80px; }
  .branch-left::before { right: -80px; }
  .branch-right::before { left: -80px; }
}

@media (max-width: 900px) {
  .branch-left { right: calc(50% + 60px); }
  .branch-right { left: calc(50% + 60px); }
  .branch::before { width: 60px; }
  .branch-left::before { right: -60px; }
  .branch-right::before { left: -60px; }
  .main-skill, .branch-skill { min-width: 130px; padding: 10px 14px; }
  .skill-name { font-size: 0.9rem; }
}

@media (max-width: 768px) {
  .tree-level { flex-direction: column; align-items: center; margin: 60px 0; gap: 30px; }
  .branch {
    position: static;
    flex-direction: row;
    justify-content: center;
    flex-wrap: wrap;
    gap: 15px;
    margin-top: 20px;
    width: 100%;
  }
  .branch::before, .branch-skill::before { display: none; }
  .toggle-branch { display: block; }
  .branch.collapsed { display: none; }
  .user-panel { position: relative; top: unset; right: unset; margin: 0 auto 20px auto; width: 100%; max-width: 400px; }
}

@media (max-width: 640px) {
  body { padding: 15px; }
  .auth-container { margin: 50px auto; padding: 20px; }
  h1 { font-size: 2rem; }
  .main-skill, .branch-skill { min-width: 120px; padding: 10px 12px; }
  .skill-name { font-size: 0.85rem; }
  .skill-level { font-size: 0.75rem; }
}

@media (max-width: 480px) {
  h1 { font-size: 1.8rem; }
  .subtitle { font-size: 1rem; }
  .main-skill, .branch-skill { min-width: 110px; padding: 8px 10px; }
  .skill-name { font-size: 0.8rem; }
}

/* Główna aplikacja */
.app-container { display: none; }

/* Drzewko umiejętności */
.skill-tree { position: relative; display: flex; flex-direction: column; align-items: center; padding: 2rem 0; }

/* Centralna oś drzewka */
.tree-axis {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 3px;
  background: var(--connector); /* seledynowy kolor z :root */
  border-radius: 3px;
  z-index: 9999; /* Zwiększ z-index aby oś była na wierzchu */
  left: 50%;
  transform: translateX(-50%) scale(1.25); /* Kompensuj skalowanie body */
  pointer-events: none; /* Zapobiega zakłócaniu interakcji z elementami */
}

/* Usuń lub zmodyfikuj regułę, która chowa oś w widoku grywalizacji */
.app-container.gamification-view .tree-axis {
  display: block !important; /* Nadpisz ukrywanie osi */
}


/* Poziomy drzewka */
.tree-level { position: relative; display: flex; justify-content: center; margin: 60px 0; z-index: 2; }

/* Główny skill na osi */
.main-skill {
  position: relative;
  padding: 12px 16px;
  border-radius: var(--radius-lg);
  text-align: center;
  min-width: 120px;
  z-index: 3;
  box-shadow: var(--shadow-md);
  cursor: pointer;
  transition: var(--transition);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.main-skill:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }



/* Skill na gałęzi */
.branch-skill {
  position: relative;
  padding: 12px 16px;
  border-radius: var(--radius-lg);
  min-width: 140px;
  text-align: center;
  cursor: pointer;
  box-shadow: var(--shadow-md);
  transition: var(--transition);
  backdrop-filter: blur(10px);
  border: 1px solid rgb(0, 0, 0);
}

.branch-skill:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }

.branch-skill.level1 { background: var(--level1); }
.branch-skill.level2 { background: var(--level2); }

/* Gałęzie (lewa i prawa) - układ poziomy */
.branch { position: absolute; top: 50%; display: flex; flex-direction: row; align-items: center; gap: 40px; transform: translateY(-50%); }
.branch-left { right: calc(50% + 100px); flex-direction: row-reverse; align-items: center; }
.branch-right { left: calc(50% + 100px); flex-direction: row; align-items: center; }
.branch::before { content: ""; position: absolute; top: 50%; width: 100px; height: 2px; background: #000000; }
.branch-left::before { right: -100px; }
.branch-right::before { left: -100px; }

/* Responsywność mobilna dodatkowa */
@media (max-width: 768px) {
  .branch { position: relative; top: auto; left: auto; right: auto; transform: none; flex-direction: row; align-items: center; gap: 20px; }
  .branch-left, .branch-right { flex-direction: row; align-items: center; }
  .branch::before { position: absolute; top: 50%; width: 60px; height: 2px; background: #000000; }
  .branch-left::before { right: -60px; }
  .branch-right::before { left: -60px; }
  .branch-skill::before { top: 50%; left: -30px; width: 30px; height: 2px; }
}


/* Mini-kafelki z filmami */
.branch-skill.mini-video {
    min-width: 180px;
    padding: 6px;
    cursor: pointer;
    border-radius: var(--radius-md);
    border: 1px solid rgb(0, 0, 0);
    background: rgba(255, 193, 7, 0.2); /* lekko żółty, pasujący do Poziomu 2 */
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    justify-content: center;
    align-items: center;
}

.branch-skill.mini-video iframe {
    width: 100%;
    height: 200px;
    border: none;
    border-radius: 6px;
}

.branch-skill.mini-video:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 6px 15px rgba(0,0,0,0.25);
}


/* Dodaj to do sekcji CSS */
.app-container.gamification-view .tree-axis {
  display: none;
}

.app-container.gamification-view .skill-tree {
  display: none;
}

.app-container.gamification-view #gamification-section {
  display: block;
}

.tree-axis {
  position: absolute;
  top: 0;
  bottom: 0;
  width: 3px;
  background: var(--connector); /* seledynowy kolor z :root */
  border-radius: 3px;
  z-index: 1;
  left: 50%;
  transform: translateX(-50%);
}

</style>





</head>
<body>
  <!-- Ekran logowania -->
  <div id="auth-container" class="auth-container">
    <h2 style="color:white">Logowanie do Umiejętności Breaking</h2>
    <div id="login-form">
      <input type="email" id="login-email" class="auth-input" placeholder="Adres email">
      <input type="password" id="login-password" class="auth-input" placeholder="Hasło">
      <div id="login-error" class="error-message"></div>
      <button id="login-btn" style="color:black" class="auth-button">Zaloguj się</button>
      <div class="auth-switch" style="color:white" id="show-register">Nie masz konta? Zarejestruj się</div>
    </div>
    
    <div id="register-form" style="display: none;">
      <input type="text" id="register-name" class="auth-input" placeholder="Imię i nazwisko">
      <input type="email" id="register-email" class="auth-input" placeholder="Adres email">
      <input type="password" id="register-password" class="auth-input" placeholder="Hasło (min. 6 znaków)">
      <div id="register-error" class="error-message"></div>
      <button id="register-btn" class="auth-button" style="color:white">Zarejestruj się</button>
      <div class="auth-switch" id="show-login" style="color:white">Masz już konto? Zaloguj się</div>
    </div>
  </div>

  <!-- Główna aplikacja -->
  <div id="app-container" class="app-container">
    <div class="container">
      <header>
        <h1>Zdobyte umiejętności Breakingu</h1>
        <p class="subtitle">Postępy w nauce breakdance</p>
      </header>
      
      <div class="skill-tree" id="skillTree">
        <div class="tree-axis"></div>
        <!-- Drzewko będzie generowane dynamicznie -->
      </div>
    </div>
    
    <div class="user-panel">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">U</div>
        <div class="user-name" id="userName">Użytkownik</div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="progress-text" id="progressText">0/25 umiejętności</div>
      <button class="logout-btn" id="logoutBtn">Wyloguj</button>
      <!-- W user-panel, pod logout-btn -->
<button class="logout-btn" id="gamificationBtn" >Grywalizacja</button>

    </div>
  </div>




  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      doc, 
      getDoc, 
      setDoc,
      updateDoc 
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { 
      getAuth, 
      createUserWithEmailAndPassword, 
      signInWithEmailAndPassword, 
      signOut, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBdhMIiqetOfDGP85ERxtgwn3AXR50pBcE",
      authDomain: "base-468e0.firebaseapp.com",
      projectId: "base-468e0",
      storageBucket: "base-468e0.appspot.com",
      messagingSenderId: "829161895559",
      appId: "1:829161895559:web:d832541aac05b35847ea22"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);


        // Zmienne globalne
    let userSkills = {};
    let currentUserId = null;
    let allUsers = [];
    let isGamificationView = false;
    let usersData = {};
    let currentUserData = null;


    // Struktura drzewka umiejętności
    const SKILL_TREE = [
      {
        id: "toprock",
        name: "Toprock",
        desc: "Podstawowe kroki wykonywane na stojąco",
        level: "Poziom podstawowy",
        branches: [
          {
            direction: "left",
            skills: [
              { id: "basic-toprock", name: "Basic Toprock", level: "Poziom 1" },
              { id: "indian-step", name: "Indian Step", level: "Poziom 1", req: ["basic-toprock"], videoUrl: "https://www.youtube-nocookie.com/embed/xOXyKlhGiLE?si=hAqhz4vdzQxmLcXD" },
              { id: "side-step", name: "Side Step", level: "Poziom 2", req: ["indian-step"] },
              { id: "crossover-step", name: "Crossover Step", level: "Poziom 2", req: ["side-step"] },
              { id: "advanced-toprock", name: "Zaawansowane Toprock", level: "Poziom 3", req: ["crossover-step"] }
            ]
          }
        ]
      },
      {
        id: "footwork",
        name: "Footwork",
        desc: "Ruchy wykonywane blisko ziemi",
        level: "Poziom średniozaawansowany",
        branches: [
          {
            direction: "right",
            skills: [
              { id: "basic-6step", name: "6-step", level: "Poziom 1" },
              { id: "cc", name: "CC (Kick-outs)", level: "Poziom 1", req: ["basic-6step"]},
              { id: "3step", name: "3-step", level: "Poziom 2", req: ["basic-6step"], videoUrl: "https://www.youtube-nocookie.com/embed/xOXyKlhGiLE?si=hAqhz4vdzQxmLcXD"  },
              { id: "coffee-grinder", name: "Coffee Grinder", level: "Poziom 2", req: ["cc"] },
              { id: "footwork-combos", name: "Kombinacje", level: "Poziom 3", req: ["3step","coffee-grinder"] }
            ]
          }
        ]
      },
      {
        id: "freezes",
        name: "Freezy",
        desc: "Pozycje zatrzymania w tańcu",
        level: "Poziom zaawansowany",
        branches: [
          {
            direction: "left",
            skills: [
              { id: "baby-freeze", name: "Baby Freeze", level: "Poziom 1" },
              { id: "chair-freeze", name: "Chair Freeze", level: "Poziom 1", req: ["baby-freeze"] },
              { id: "airchair", name: "Airchair", level: "Poziom 2", req: ["chair-freeze"] },
              { id: "handstand-freeze", name: "Handstand Freeze", level: "Poziom 2", req: ["baby-freeze"] },
              { id: "combo-freezes", name: "Kombinacje Freezów", level: "Poziom 3", req: ["airchair","handstand-freeze"] }
            ]
          }
        ]
      },
      {
        id: "powermoves",
        name: "Powermoves",
        desc: "Dynamiczne ruchy wymagające siły",
        level: "Poziom ekspert",
        branches: [
       
          {
            direction: "right",
            skills: [
              { id: "backspin", name: "Backspin", level: "Poziom 1" },
              { id: "windmill", name: "Windmill", level: "Poziom 1", req: ["backspin"] },
              { id: "flare", name: "Flare", level: "Poziom 2", req: ["windmill"] },
              { id: "headspin", name: "Headspin", level: "Poziom 2", req: ["windmill"] },
              { id: "airflare", name: "Airflare", level: "Poziom 3", req: ["flare","headspin"] }
            ]
          }
        ]
      },
      {
        id: "style",
        name: "Styl i muzykalność",
        desc: "Rozwijanie własnego stylu",
        level: "Poziom mistrzowski",
        branches: [
          {
            direction: "left",
            skills: [
              { id: "rhythm", name: "Czucie rytmu", level: "Poziom 1" },
              { id: "musicality", name: "Muzykalność", level: "Poziom 2", req: ["rhythm"] },
              { id: "transitions", name: "Płynne przejścia", level: "Poziom 2", req: ["musicality"] },
              { id: "personal-style", name: "Własny styl", level: "Poziom 3", req: ["transitions"] }
            ]
          }
        ]
      }
    ];



    // Referencje do elementów DOM
    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');
    const userAvatar = document.getElementById('userAvatar');
    const userName = document.getElementById('userName');
    const logoutBtn = document.getElementById('logoutBtn');
    const skillTree = document.getElementById('skillTree');



    // Przełączanie między formularzami
    document.getElementById('show-register').addEventListener('click', () => {
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
      registerError.textContent = '';
    });

    document.getElementById('show-login').addEventListener('click', () => {
      registerForm.style.display = 'none';
      loginForm.style.display = 'block';
      loginError.textContent = '';
    });

    // Logowanie
    document.getElementById('login-btn').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      try {
        await signInWithEmailAndPassword(auth, email, password);
        loginError.textContent = '';
      } catch (error) {
        console.error('Błąd logowania:', error);
        loginError.textContent = getAuthErrorMessage(error.code);
      }
    });

    // Rejestracja
    document.getElementById('register-btn').addEventListener('click', async () => {
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      
      if (!name) {
        registerError.textContent = 'Podaj imię i nazwisko';
        return;
      }
      
      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        
        // Utwórz dokument użytkownika w Firestore
        await setDoc(doc(db, "users", user.uid), {
          name: name,
          email: email,
          role: "user",
          skills: {},
          createdAt: new Date()
        });
        
        registerError.textContent = '';
      } catch (error) {
        console.error('Błąd rejestracji:', error);
        registerError.textContent = getAuthErrorMessage(error.code);
      }
    });

    // Wylogowanie
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (error) {
        console.error('Błąd wylogowania:', error);
      }
    });

    // Obserwuj stan autentykacji
   // Obserwuj stan autentykacji
onAuthStateChanged(auth, async (user) => {
  if (user) {
    // Użytkownik zalogowany
    currentUserId = user.uid;
    authContainer.style.display = 'none';
    appContainer.style.display = 'block';
    
    // Pobierz dane użytkownika
    const userDoc = await getDoc(doc(db, "users", user.uid));
    currentUserData = userDoc.exists() ? userDoc.data() : {};
    
    // Ustaw informacje o użytkowniku
    userAvatar.textContent = currentUserData.name ? currentUserData.name.charAt(0).toUpperCase() : user.email.charAt(0).toUpperCase();
    userName.textContent = currentUserData.name || user.email;
    
    // Załaduj umiejętności użytkownika
    await loadUserSkills();
    renderSkillTree();
    
    // Załaduj wszystkich użytkowników
    await loadAllUsers();
  } else {
    // Użytkownik wylogowany
    currentUserId = null;
    currentUserData = null;
    authContainer.style.display = 'block';
    appContainer.style.display = 'none';
  }
});

    // Załaduj umiejętności użytkownika z Firestore
// Załaduj umiejętności użytkownika z Firestore
async function loadUserSkills() {
  if (!currentUserId) return;
  
  try {
    const userDoc = await getDoc(doc(db, "users", currentUserId));
    if (userDoc.exists()) {
      const userData = userDoc.data();
      userSkills = userData.skills || {};
      usersData[currentUserId] = userData; // Zapisz dane bieżącego użytkownika
    } else {
      userSkills = {};
    }
  } catch (error) {
    console.error("Błąd ładowania umiejętności:", error);
    userSkills = {};
  }
}

// Funkcja do renderowania drzewka
// Funkcja do renderowania drzewka
// Funkcja do renderowania drzewka
function renderSkillTree() {
  skillTree.innerHTML = '';
  
  // Dodaj centralną oś
    //const axis = document.createElement('div');
    //axis.className = 'tree-axis';
    //skillTree.appendChild(axis);
  
  // Renderuj każdy poziom drzewka
  SKILL_TREE.forEach((category, index) => {
    const level = document.createElement('div');
    level.className = 'tree-level';
    
    // Dodaj łącznik (oprócz pierwszego poziomu)
    if (index > 0) {
      const connector = document.createElement('div');
      connector.className = 'connector vertical-connector';
      level.appendChild(connector);
    }
    
    // Główna umiejętność kategorii
    const mainSkill = document.createElement('div');
    const mainSkillLevel = userSkills[category.id] || 3;
    mainSkill.className = `main-skill level${mainSkillLevel}`;
    mainSkill.innerHTML = `<div class="skill-name">${category.name}</div>`;
    level.appendChild(mainSkill);
    
    // Przycisk do zwijania/rozwijania gałęzi (tylko na urządzeniach mobilnych)
    if (window.innerWidth <= 768) {
      const toggleBtn = document.createElement('i');
      toggleBtn.className = 'fas fa-eye-slash toggle-branch';
      toggleBtn.onclick = function() {
  const branches = level.querySelectorAll('.branch');
  branches.forEach(branch => branch.classList.toggle('collapsed'));
  toggleBtn.classList.toggle('fa-eye-slash');
  toggleBtn.classList.toggle('fa-eye');
};
      level.appendChild(toggleBtn);
    }
    
    // Renderuj gałęzie (lewa i prawa)
    category.branches.forEach(branch => {
      const branchDiv = document.createElement('div');
      branchDiv.className = `branch branch-${branch.direction}`;
      
      let totalSkillsInBranch = branch.skills.length;
      let unlockedSkillsInBranch = 0;
      let hasVisibleSkills = false;
      
      // Najpierw policz wszystkie umiejętności (w tym z filmem)
      branch.skills.forEach(skill => {
        const userLevel = userSkills[skill.id] || 0;
        
        // Umiejętność jest odblokowana jeśli ma poziom 1 lub 2
        if (userLevel === 1 || userLevel === 2) {
          unlockedSkillsInBranch++;
        }
      });
      
      // Teraz renderuj umiejętności
      branch.skills.forEach(skill => {
        const userLevel = userSkills[skill.id] || 0; // 0 = zablokowane
        
        // UKRYJ KAFELKI BEZ POZIOMU 1 ANI 2
        if (userLevel !== 1 && userLevel !== 2) {
          return; // Pomijamy renderowanie tego kafelka
        }
        
        hasVisibleSkills = true;
        
        const skillElement = document.createElement('div');
        skillElement.className = `branch-skill level${userLevel}`;
        
        // TYLKO nazwa umiejętności - UKRYJ POZIOM
        skillElement.innerHTML = `<div class="skill-name">${skill.name}</div>`;
        
        // Jeśli skill ma videoUrl, dodaj iframe
        if (skill.videoUrl) {
          const iframe = document.createElement('iframe');
          iframe.src = skill.videoUrl;
          iframe.allowFullscreen = true;
          iframe.style.width = '100%';
          iframe.style.height = '100px';
          iframe.style.marginTop = '5px';
          skillElement.appendChild(iframe);
        }
        
        branchDiv.appendChild(skillElement);
      });
      
      // Dodaj licznik postępu dla gałęzi tylko jeśli są widoczne umiejętności
      if (hasVisibleSkills) {
        const branchProgress = document.createElement('div');
        branchProgress.className = 'branch-progress';
        branchProgress.innerHTML = `<div class="progress-text">${unlockedSkillsInBranch}/${totalSkillsInBranch}</div>`;
        branchDiv.appendChild(branchProgress);
        
        level.appendChild(branchDiv);
      }
    });
    
    skillTree.appendChild(level);
  });
  
  // Aktualizuj postęp
  updateProgress();
}


    
    // Aktualizuj pasek postępu
    function updateProgress() {
      const totalSkills = SKILL_TREE.reduce((total, category) => {
        return total + category.branches.reduce((branchTotal, branch) => {
          return branchTotal + branch.skills.length;
        }, 0) + 1;
      }, 0);
      
      const unlockedSkills = Object.values(userSkills).filter(level => level === 1 || level === 2).length;
      const progressPercent = (unlockedSkills / totalSkills) * 100;
      
      document.getElementById('progressFill').style.width = `${progressPercent}%`;
      document.getElementById('progressText').textContent = 
        `${unlockedSkills}/${totalSkills} umiejętności`;
    }
    
    // Funkcja do tłumaczenia kodów błędów Firebase
    function getAuthErrorMessage(errorCode) {
      switch (errorCode) {
        case 'auth/email-already-in-use':
          return 'Ten adres email jest już używany.';
        case 'auth/invalid-email':
          return 'Nieprawidłowy adres email.';
        case 'auth/operation-not-allowed':
          return 'Operacja nie jest dozwolona.';
        case 'auth/weak-password':
          return 'Hasło jest zbyt słabe. Użyj co najmniej 6 znaków.';
        case 'auth/user-disabled':
          return 'Konto zostało wyłączone.';
        case 'auth/user-not-found':
          return 'Nie znaleziono użytkownika.';
        case 'auth/wrong-password':
          return 'Nieprawidłowe hasło.';
        default:
          return 'Wystąpił nieznany błąd. Spróbuj ponownie.';
      }
    }
    
    // Funkcja zwracająca tekst dla poziomu umiejętności
    function getLevelText(level) {
      switch(level) {
        case 1: return "Poziom 1";
        case 2: return "Poziom 2";
        default: return "Nieokreślony poziom";
      }
    }

    


// Funkcja do ładowania wszystkich użytkowników
// Funkcja do ładowania wszystkich użytkowników
async function loadAllUsers() {
  try {
    const usersSnapshot = await getDocs(collection(db, "users"));
    allUsers = [];
    
    usersSnapshot.forEach(doc => {
      const userData = doc.data();
      usersData[doc.id] = userData;
      
      // Wyklucz obecnego użytkownika i adminów
      if (doc.id !== currentUserId && userData.role !== 'admin') {
        allUsers.push({
          id: doc.id,
          ...userData
        });
      }
    });
  } catch (error) {
    console.error("Błąd ładowania użytkowników:", error);
  }
}

// Funkcja do renderowania kafelków użytkowników
function renderUsersGrid() {
  const usersGrid = document.getElementById('users-grid');
  usersGrid.innerHTML = '';
  
  allUsers.forEach(user => {
    const userCard = document.createElement('div');
    userCard.className = 'user-card';
    userCard.style.cssText = `
      background: #f5f5f5;
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s;
      border: 2px solid #ddd;
    `;
    
    userCard.innerHTML = `
      <div style="font-size: 24px; margin-bottom: 10px;">${user.name?.charAt(0)?.toUpperCase() || 'U'}</div>
      <h3 style="margin: 5px 0; color: #333;">${user.name || 'Użytkownik'}</h3>
      <p style="color: #666; font-size: 12px;">${calculateProgress(user.skills || {})}% ukończonych</p>
    `;
    
    userCard.addEventListener('click', () => {
      viewUserSkills(user.id, user.name);
    });
    
    userCard.addEventListener('mouseenter', () => {
      userCard.style.transform = 'translateY(-5px)';
      userCard.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
    });
    
    userCard.addEventListener('mouseleave', () => {
      userCard.style.transform = 'translateY(0)';
      userCard.style.boxShadow = 'none';
    });
    
    usersGrid.appendChild(userCard);
  });
}

// Funkcja obliczająca postęp
function calculateProgress(skills) {
  const totalSkills = SKILL_TREE.reduce((total, category) => {
    return total + category.branches.reduce((branchTotal, branch) => {
      return branchTotal + branch.skills.length;
    }, 0) + 1;
  }, 0);
  
  const unlockedSkills = Object.values(skills).filter(level => level === 1 || level === 2).length;
  return Math.round((unlockedSkills / totalSkills) * 100);
}

// Funkcja do podglądu umiejętności innego użytkownika
// Funkcja do podglądu umiejętności innego użytkownika
async function viewUserSkills(userId, userName) {
  try {
    // Ukryj grywalizację i pokaż drzewko
    document.getElementById('gamification-section').style.display = 'none';
    document.getElementById('skillTree').style.display = 'block';
    isGamificationView = false;
    
    const userDoc = await getDoc(doc(db, "users", userId));
    if (userDoc.exists()) {
      userSkills = userDoc.data().skills || {};
      document.getElementById('userName').textContent = `${userName} (podgląd)`;
      renderSkillTree();
      
      // Dodaj przycisk powrotu (jeśli jeszcze nie istnieje)
      let backButton = document.getElementById('backButton');
      if (!backButton) {
        backButton = document.createElement('button');
        backButton.id = 'backButton';
        backButton.textContent = 'Powrót do mojego widoku';
        backButton.style.cssText = `
          padding: 10px 15px;
          background: #ff6b6b;
          color: white;
          border: none;
          border-radius: 8px;
          cursor: pointer;
          margin: 10px 0;
          width: 100%;
        `;
        
        backButton.onclick = async () => {
          await loadUserSkills();
          document.getElementById('userName').textContent = currentUserData?.name || 'Użytkownik';
          renderSkillTree();
          backButton.remove();
        };
        
        const userPanel = document.querySelector('.user-panel');
        userPanel.appendChild(backButton);
      }
    }
  } catch (error) {
    console.error("Błąd ładowania umiejętności użytkownika:", error);
  }
}




// Obsługa przycisku Grywalizacja
document.getElementById('gamificationBtn').addEventListener('click', async () => {
  isGamificationView = !isGamificationView;
  
  if (isGamificationView) {
    await loadAllUsers();
    document.getElementById('gamification-section').style.display = 'block';
    document.getElementById('skillTree').style.display = 'none';
    
    // Usuń przycisk powrotu jeśli istnieje
    const backButton = document.getElementById('backButton');
    if (backButton) {
      backButton.remove();
    }
    
    renderUsersGrid();
  } else {
    document.getElementById('gamification-section').style.display = 'none';
    document.getElementById('skillTree').style.display = 'block';
  }
});

  </script>

  <!-- W app-container, pod header ale przed skill-tree -->
<div id="gamification-section" style="margin: 20px 0; display: none;">
  <h2>Grywalizacja</h2>
  <div id="users-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;"></div>
</div>



</body>
</html>
